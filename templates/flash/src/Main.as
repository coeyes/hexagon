package {	import commands.CommandInvoker;	import commands.env.InitApplicationCommand;	import managers.CommandManager;	import model.Config;	import model.Data;	import util.FPSMonitor;	import util.Log;	import view.ApplicationUI;	import com.hexagonstar.core.Application;	import com.hexagonstar.display.StageReference;	import com.hexagonstar.env.command.ICommandListener;	import com.hexagonstar.env.console.CLICommand;	import com.hexagonstar.env.console.Console;	import com.hexagonstar.env.event.CommandCompleteEvent;	import com.hexagonstar.env.event.CommandErrorEvent;	import com.hexagonstar.env.event.CommandProgressEvent;	import flash.events.Event;	import flash.events.EventDispatcher;	/** 	 * An event indicating that the application is ready for	 * user interaction after initialization steps are done.	 */	[Event(name="applicationInitialized", type="flash.events.Event")]			/**	 * The central class, or 'Mediator' of the application.	 * @author Sascha Balkau	 */	public final class Main extends EventDispatcher implements ICommandListener	{		////////////////////////////////////////////////////////////////////////////////////////		// Constants                                                                          //		////////////////////////////////////////////////////////////////////////////////////////				public static const APPLICATION_INITIALIZED:String = "applicationInitialized";						////////////////////////////////////////////////////////////////////////////////////////		// Properties                                                                         //		////////////////////////////////////////////////////////////////////////////////////////				private static var _instance:Main;		private static var _singletonLock:Boolean = false;				private var _app:Application;		private var _ui:ApplicationUI;		private var _console:Console;		private var _fpsMonitor:FPSMonitor;				private var _appInfo:AppInfo;		private var _embeddedAssets:EmbeddedAssets;				private var _commandManager:CommandManager;		private var _commandInvoker:CommandInvoker;				private var _config:Config;		private var _data:Data;						////////////////////////////////////////////////////////////////////////////////////////		// Public Methods                                                                     //		////////////////////////////////////////////////////////////////////////////////////////				/**		 * Creates a new instance of Main. As Main is a Singleton it is required		 * to use the instance getter instead of direct instantiation.		 */		public function Main()		{			if (!_singletonLock)			{				throw new Error("Tried to instantiate Main through it's constructor."					+ " Use Main.instance instead!");			}		}						/**		 * Invokes the application's (user-defined) initialization process.		 */		public function init():void		{			_commandManager.execute(new InitApplicationCommand(this));		}						/**		 * Sets config properties that should be available as soon as possible.		 * This method is called by the InitApplicationCommand as soon as the		 * app config file has been loaded. It should not be called manually.		 */		public function secondarySetup():void		{			/* Initialize the Logger */			Log.init();			Log.filterLevel = _config.loggingFilterLevel;			Log.enabled = _config.loggingEnabled;						/* Set the default locale as the currently used locale. */			config.currentLocale = config.defaultLocale.toLowerCase();						/* We make the console available to the user right after the config			 * file was loaded in case data file loading takes long (e.g. on the web). */			createFPSMonitor();			createConsole();		}						////////////////////////////////////////////////////////////////////////////////////////		// Getters & Setters                                                                  //		////////////////////////////////////////////////////////////////////////////////////////				public static function get instance():Main		{			if (_instance == null)			{				_singletonLock = true;				_instance = new Main();				_singletonLock = false;			}			return _instance;		}						public static function get app():Application		{			return _instance._app;		}						public static function get ui():ApplicationUI		{			return _instance._ui;		}						public static function get config():Config		{			return _instance._config;		}						public static function get data():Data		{			return _instance._data;		}						////////////////////////////////////////////////////////////////////////////////////////		// Event Handlers                                                                     //		////////////////////////////////////////////////////////////////////////////////////////				/**		 * Invoked by App after the application has finished loading.		 * 		 * @param app a reference to the application class.		 */		public function onApplicationLoaded(app:Application):void		{			_app = app;						setup();			init();		}						/**		 * Invoked whenever the ApplicationInitCommand dispatches a progress event.		 * @private		 */		public function onCommandProgress(e:CommandProgressEvent):void		{			Log.debug("ApplicationInitProgress #" + e.progress + ": "  + e.progressMessage);		}						/**		 * Invoked if the ApplicationInitCommand dispatches an error event.		 * @private		 */		public function onCommandError(e:CommandErrorEvent):void		{			Log.error("ApplicationInitError: " + e.text);		}						/**		 * Invoked when the ApplicationInitCommand dispatches a complete event.		 * @private		 */		public function onCommandComplete(e:CommandCompleteEvent):void		{			Log.debug("ApplicationInitComplete.");						/* Dispatch event to signal that the app is ready */			dispatchEvent(new Event(APPLICATION_INITIALIZED));		}						////////////////////////////////////////////////////////////////////////////////////////		// Private Methods                                                                    //		////////////////////////////////////////////////////////////////////////////////////////				/**		 * Executes tasks that need to be done before the init process is executed.		 * This usually includes creating the application's user interface. This		 * method should only ever need to be called once during application life time.		 * @private		 */		private function setup():void		{			/* Set stage reference */			StageReference.stage = _app.stage;						/* Create Config and Data model */			_config = new Config();			_data = new Data();						_commandManager = CommandManager.instance;						createUI();		}						/**		 * Creates the application UI.		 * @private		 */		private function createUI():void		{			_ui = new ApplicationUI();			_app.addChild(_ui);		}						/**		 * createFPSMonitor		 * @private		 */		private function createFPSMonitor():void		{			if (!_fpsMonitor && _config.fpsMonitorEnabled)			{				_fpsMonitor = FPSMonitor.instance;				_fpsMonitor.pollInterval = _config.fpsMonitorPollInterval;				_app.addChild(_fpsMonitor);			}		}						/**		 * Creates the debug console.		 * @private		 */		private function createConsole():void		{			if (!_console && _config.consoleEnabled)			{				_commandInvoker = new CommandInvoker();								_console = Console.instance;				_console.cliCommandInvoker = _commandInvoker;				_console.consoleEnabled = _config.consoleEnabled;				_console.transparency = _config.consoleTransparency;				_console.maxBufferSize = _config.consoleMaxBufferSize;				_console.setFont(EmbeddedAssets.fontConsolas.fontName, _config.consoleFontSize);				_app.addChild(_console);								if (_config.consoleEnabled && _config.consoleAutoOpen)				{					_console.toggle();				}								var cmd1:CLICommand = new CLICommand();				cmd1.command = "appInit";				cmd1.help = "Initializes the application.";				cmd1.handler = "appInit";				_console.addCLICommand(cmd1);								var cmd2:CLICommand = new CLICommand();				cmd2.command = "appInfo";				cmd2.help = "Displays application information string.";				cmd2.handler = "appInfo";				_console.addCLICommand(cmd2);								if (_config.fpsMonitorEnabled)				{					var cmd3:CLICommand = new CLICommand();					cmd3.command = "appFPS";					cmd3.help = "Toggles the FPS Monitor on/off.";					cmd3.handler = "appFPSToggle";					_console.addCLICommand(cmd3);				}			}		}	}}